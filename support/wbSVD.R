library(wbstats)
library(tidyverse)
library(rgdal)
library(rworldmap)
library(plotly)
library(reshape2)

# gdp per capita, life expectancy, literacy rate
inds <- c('NY.GDP.PCAP.CD', 'SP.DYN.LE00.IN', 'SE.ADT.LITR.ZS')

# get data from world bank
data <- wb(country='countries_only', indicator=inds, 
           startdate=2007, enddate=2017, return_wide = TRUE, POSIXct = TRUE) %>% as_tibble()
summary(data)
dataS <- data %>% select('country', 'date', inds)

# aggregate over 10 year period
dataM <- dataS %>% group_by(country) %>%
  summarize_at(vars(-c(date,country)), funs(mean(., na.rm=T)))
dataM <- left_join(dataM, unique(data[, c('country', 'iso3c')]), by='country')
summary(dataM)
dataM

# replace literacy rate NAs with 97.5 (mostly OECD)
dataM$SE.ADT.LITR.ZS <- ifelse(is.na(dataM$SE.ADT.LITR.ZS), 97.5, dataM$SE.ADT.LITR.ZS)

# filter NAs
dataM <- dataM %>% filter(!is.na(NY.GDP.PCAP.CD), !is.na(SP.DYN.LE00.IN), !is.na(SE.ADT.LITR.ZS))
dataM
colnames(dataM)[2:4] <- c('pcgdp', 'lifexp', 'litr')

# 2D, 3D plots
# dataP <- dataM %>% filter(!is.na(pcgdp) & !is.na(lifexp) & !is.na(litr))

plot_ly(data=dataM, x=~pcgdp, y=~lifexp,
        mode='markers', 
        hoverinfo='text',
        text=~country)

fit2d <- lm(lifexp ~ pcgdp, data = dataM)

plot_ly(data=dataM, x=~pcgdp, y=~lifexp,
        mode='markers', 
        hoverinfo='text',
        text=~country) %>%
  add_markers() %>%
  add_lines(x=~pcgdp, y=fitted(fit2d)) %>%
  layout(showlegend = FALSE)


plot_ly(data=dataM, x=~pcgdp, y=~litr, z=~lifexp,
        mode='markers', 
        hoverinfo='text',
        text=~country)

fit3d <- lm(lifexp ~ pcgdp + litr, data = dataM)

xresolution <- 100
yresolution <- 1

#Setup Axis
axis_x <- seq(min(dataM$pcgdp), max(dataM$pcgdp), by = xresolution)
axis_y <- seq(min(dataM$litr), max(dataM$litr), by = yresolution)

surface <- expand.grid(pcgdp=axis_x, litr=axis_y)
surface$lifexp <- predict.lm(fit3d, surface)
surface2 <- acast(surface, litr ~ pcgdp, value.var = "lifexp") #y ~ x


d <- dataM %>% select(pcgdp, litr)
vals <- predict(fit3d, newdata=d)
m <- matrix(vals, nrow=length(unique(dataM$pcgdp)), ncol=length(unique(dataM$litr)))

plot_ly(data=dataM, x=~pcgdp, y=~litr, z=~lifexp,
        mode='markers', 
        hoverinfo='text',
        text=~country) %>%
  add_markers() %>%
  add_surface(x=axis_x, y=axis_y, z=surface2)

# drop identifiers
dataV <- dataM %>% select(inds)

# calculate principal components
pca <- prcomp(dataV, scale.=T)
pca1 <- pca$x[,1]

# reappend country names
pcaN <- cbind.data.frame(dataM$country, pca1)
pcaN %>% arrange(pca1)

# create map
pcaISO <- cbind.data.frame(dataM$iso3c, pca1)
pcaISO %>% arrange(pca1)
colnames(pcaISO) <- c('iso3c', 'pca1')
mapData <- joinCountryData2Map(pcaISO, joinCode = 'ISO3', nameJoinColumn = 'iso3c')

png(filename='test.png', width=1000, height=750)
mapCountryData(mapData, nameColumnToPlot = 'pca1', mapTitle = 'Economic Development Index', catMethod = 'pretty')
dev.off()
